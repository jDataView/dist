!function(a){var b=this;"object"==typeof exports?module.exports=a(b,require("jdataview")):"function"==typeof define&&define.amd?define(["jdataview"],function(c){return a(b,c)}):b.jBinary=a(b,b.jDataView)}(function(a,b,c){"use strict";function d(a,b){return b&&a instanceof b}function e(a){for(var b=1,d=arguments.length;d>b;++b){var e=arguments[b];for(var f in e)e[f]!==c&&(a[f]=e[f])}return a}function f(a){return arguments[0]=o(a),e.apply(null,arguments)}function g(a,b,c){return d(c,Function)?c.call(a,b.contexts[0]):c}function h(a){return function(){var b=arguments,e=b.length-1,f=a.length-1,g=b[e];if(b.length=f+1,!d(g,Function)){var h=this;return new n(function(c,d){b[f]=function(a,b){return a?d(a):c(b)},a.apply(h,b)})}b[e]=c,b[f]=g,a.apply(this,b)}}function i(a,e){return d(a,i)?a.as(e):(d(a,b)||(a=new b(a,c,c,e?e["jBinary.littleEndian"]:c)),d(this,i)?(this.view=a,this.view.seek(0),this.contexts=[],this.as(e,!0)):new i(a,e))}function j(a){return f(j.prototype,a)}function k(a){return f(k.prototype,a,{createProperty:function(){var b=(a.createProperty||k.prototype.createProperty).apply(this,arguments);return b.getBaseType&&(b.baseType=b.binary.getType(b.getBaseType(b.binary.contexts[0]))),b}})}var l=a.document;if("atob"in a&&"btoa"in a||!function(){function b(a){var b,c,e,f,g,h;for(e=a.length,c=0,b="";e>c;){if(f=255&a.charCodeAt(c++),c==e){b+=d.charAt(f>>2),b+=d.charAt((3&f)<<4),b+="==";break}if(g=a.charCodeAt(c++),c==e){b+=d.charAt(f>>2),b+=d.charAt((3&f)<<4|(240&g)>>4),b+=d.charAt((15&g)<<2),b+="=";break}h=a.charCodeAt(c++),b+=d.charAt(f>>2),b+=d.charAt((3&f)<<4|(240&g)>>4),b+=d.charAt((15&g)<<2|(192&h)>>6),b+=d.charAt(63&h)}return b}function c(a){var b,c,d,f,g,h,i;for(h=a.length,g=0,i="";h>g;){do b=e[255&a.charCodeAt(g++)];while(h>g&&-1==b);if(-1==b)break;do c=e[255&a.charCodeAt(g++)];while(h>g&&-1==c);if(-1==c)break;i+=String.fromCharCode(b<<2|(48&c)>>4);do{if(d=255&a.charCodeAt(g++),61==d)return i;d=e[d]}while(h>g&&-1==d);if(-1==d)break;i+=String.fromCharCode((15&c)<<4|(60&d)>>2);do{if(f=255&a.charCodeAt(g++),61==f)return i;f=e[f]}while(h>g&&-1==f);if(-1==f)break;i+=String.fromCharCode((3&d)<<6|f)}return i}var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1];a.btoa||(a.btoa=b),a.atob||(a.atob=c)}(),!b&&l){var m="jBinary_activate";a[m]=function(){try{delete a[m]}catch(d){a[m]=c}b=a.jDataView},l.write('<script src="//jdataview.github.io/dist/jdataview.js"></script><script>'+m+"()</script>")}var n=a.Promise||function(a){this.then=a},o=Object.create;o||(o=function(a){var b=function(){};return b.prototype=a,new b});var p=i.prototype,q=p.typeSet={};p.toValue=function(a){return g(this,this,a)};var r=Object.defineProperty;if(r)try{r({},"x",{})}catch(s){r=c}else r=function(a,b,c,d){d&&(a[b]=c.value)};var t="jBinary.Cache",u=0;p._getCached=function(a,b,c){if(a.hasOwnProperty(this.cacheKey))return a[this.cacheKey];var d=b.call(this,a);return r(a,this.cacheKey,{value:d},c),d},p.getContext=function(a){switch(typeof a){case"undefined":a=0;case"number":return this.contexts[a];case"string":return this.getContext(function(b){return a in b});case"function":for(var b=0,c=this.contexts.length;c>b;b++){var d=this.contexts[b];if(a.call(this,d))return d}}},p.inContext=function(a,b){this.contexts.unshift(a);var c=b.call(this);return this.contexts.shift(),c},j.prototype={inherit:function(a,b){function c(a,b){var c=e[a];c&&(d||(d=f(e)),b.call(d,c),d[a]=null)}var d,e=this;return c("params",function(b){for(var c=0,d=b.length;d>c;c++)this[b[c]]=a[c]}),c("setParams",function(b){b.apply(this,a)}),c("typeParams",function(a){for(var c=0,d=a.length;d>c;c++){var e=a[c],f=this[e];f&&(this[e]=b(f))}}),c("resolve",function(a){a.call(this,b)}),d||e},createProperty:function(a){return f(this,{binary:a,view:a.view})},toValue:function(a,b){return b!==!1&&"string"==typeof a?this.binary.getContext(a)[a]:g(this,this.binary,a)}},i.Type=j,k.prototype=f(j.prototype,{setParams:function(){this.baseType&&(this.typeParams=["baseType"].concat(this.typeParams||[]))},baseRead:function(){return this.binary.read(this.baseType)},baseWrite:function(a){return this.binary.write(this.baseType,a)}}),e(k.prototype,{read:k.prototype.baseRead,write:k.prototype.baseWrite}),i.Template=k,p.as=function(a,b){var c=b?this:f(this);return a=a||q,c.typeSet=a===q||q.isPrototypeOf(a)?a:f(q,a),c.cacheKey=t,c.cacheKey=c._getCached(a,function(){return t+"."+ ++u},!0),c},p.seek=function(a,b){if(a=this.toValue(a),b!==c){var d=this.view.tell();this.view.seek(a);var e=b.call(this);return this.view.seek(d),e}return this.view.seek(a)},p.tell=function(){return this.view.tell()},p.skip=function(a,b){return this.seek(this.tell()+this.toValue(a),b)},p.slice=function(a,b,c){return new i(this.view.slice(a,b,c),this.typeSet)},p.getType=function(a,b){switch(typeof a){case"string":if(!(a in this.typeSet))throw new ReferenceError("Unknown type: "+a);return this.getType(this.typeSet[a],b);case"number":return this.getType(q.bitfield,[a]);case"object":if(d(a,j)){var c=this;return a.inherit(b||[],function(a){return c.getType(a)})}return d(a,Array)?this._getCached(a,function(a){return this.getType(a[0],a.slice(1))},!0):this._getCached(a,function(a){return this.getType(q.object,[a])},!1)}},p.createProperty=function(a){return this.getType(a).createProperty(this)},p._action=function(a,b,d){return a!==c?b!==c?this.seek(b,d):d.call(this):void 0},p.read=function(a,b){return this._action(a,b,function(){return this.createProperty(a).read(this.contexts[0])})},p.readAll=function(){return this.read("jBinary.all",0)},p.write=function(a,b,c){return this._action(a,c,function(){var c=this.tell();return this.createProperty(a).write(b,this.contexts[0]),this.tell()-c})},p.writeAll=function(a){return this.write("jBinary.all",a,0)},function(a,b){for(var c=0,d=b.length;d>c;c++){var e=b[c];q[e.toLowerCase()]=f(a,{dataType:e})}}(j({params:["littleEndian"],read:function(){return this.view["get"+this.dataType](c,this.littleEndian)},write:function(a){this.view["write"+this.dataType](a,this.littleEndian)}}),["Uint8","Uint16","Uint32","Uint64","Int8","Int16","Int32","Int64","Float32","Float64","Char"]),e(q,{"byte":q.uint8,"float":q.float32,"double":q.float64}),q.array=k({params:["baseType","length"],read:function(){var a=this.toValue(this.length);if(this.baseType===q.uint8)return this.view.getBytes(a,c,!0,!0);var b;if(a!==c){b=new Array(a);for(var d=0;a>d;d++)b[d]=this.baseRead()}else{var e=this.view.byteLength;for(b=[];this.binary.tell()<e;)b.push(this.baseRead())}return b},write:function(a){if(this.baseType===q.uint8)return this.view.writeBytes(a);for(var b=0,c=a.length;c>b;b++)this.baseWrite(a[b])}}),q.binary=k({params:["length","typeSet"],read:function(){var a=this.binary.tell(),b=this.binary.skip(this.toValue(this.length)),c=this.view.slice(a,b);return new i(c,this.typeSet)},write:function(a){this.binary.write("blob",a.read("blob",0))}}),q.bitfield=j({params:["bitSize"],read:function(){return this.view.getUnsigned(this.bitSize)},write:function(a){this.view.writeUnsigned(a,this.bitSize)}}),q.blob=j({params:["length"],read:function(){return this.view.getBytes(this.toValue(this.length))},write:function(a){this.view.writeBytes(a,!0)}}),q["const"]=k({params:["baseType","value","strict"],read:function(){var a=this.baseRead();if(this.strict&&a!==this.value){if(d(this.strict,Function))return this.strict(a);throw new TypeError("Unexpected value ("+a+" !== "+this.value+").")}return a},write:function(a){this.baseWrite(this.strict||a===c?this.value:a)}}),q["enum"]=k({params:["baseType","matches"],setParams:function(a,b){this.backMatches={};for(var c in b)this.backMatches[b[c]]=c},read:function(){var a=this.baseRead();return a in this.matches?this.matches[a]:a},write:function(a){this.baseWrite(a in this.backMatches?this.backMatches[a]:a)}}),q.extend=j({setParams:function(){this.parts=arguments},resolve:function(a){for(var b=this.parts,c=b.length,d=new Array(c),e=0;c>e;e++)d[e]=a(b[e]);this.parts=d},read:function(){var a=this.parts,b=this.binary.read(a[0]);return this.binary.inContext(b,function(){for(var c=1,d=a.length;d>c;c++)e(b,this.read(a[c]))}),b},write:function(a){var b=this.parts;this.binary.inContext(a,function(){for(var c=0,d=b.length;d>c;c++)this.write(b[c],a)})}}),q["if"]=k({params:["condition","trueType","falseType"],typeParams:["trueType","falseType"],getBaseType:function(){return this.toValue(this.condition)?this.trueType:this.falseType}}),q.if_not=q.ifNot=k({setParams:function(a,b,c){this.baseType=["if",a,c,b]}}),q.lazy=k({marker:"jBinary.Lazy",params:["innerType","length"],getBaseType:function(){return["binary",this.length,this.binary.typeSet]},read:function(){var a=function(b){return 0===arguments.length?"value"in a?a.value:a.value=a.binary.read(a.innerType):e(a,{wasChanged:!0,value:b}).value};return a[this.marker]=!0,e(a,{binary:e(this.baseRead(),{contexts:this.binary.contexts.slice()}),innerType:this.innerType})},write:function(a){a.wasChanged||!a[this.marker]?this.binary.write(this.innerType,a()):this.baseWrite(a.binary)}}),q.object=j({params:["structure","proto"],resolve:function(a){var b={};for(var c in this.structure)b[c]=d(this.structure[c],Function)?this.structure[c]:a(this.structure[c]);this.structure=b},read:function(){var a=this,b=this.structure,e=this.proto?f(this.proto):{};return this.binary.inContext(e,function(){for(var f in b){var g=d(b[f],Function)?b[f].call(a,e):this.read(b[f]);g!==c&&(e[f]=g)}}),e},write:function(a){var b=this,c=this.structure;this.binary.inContext(a,function(){for(var e in c)d(c[e],Function)?a[e]=c[e].call(b,a):this.write(c[e],a[e])})}}),q.skip=j({params:["length"],read:function(){this.view.skip(this.toValue(this.length))},write:function(){this.read()}}),q.string=k({params:["length","encoding"],read:function(){return this.view.getString(this.toValue(this.length),c,this.encoding)},write:function(a){this.view.writeString(a,this.encoding)}}),q.string0=j({params:["length","encoding"],read:function(){var a=this.view,b=this.length;if(b===c){var d,e=a.tell(),f=0;for(b=a.byteLength-e;b>f&&(d=a.getUint8());)f++;var g=a.getString(f,e,this.encoding);return b>f&&a.skip(1),g}return a.getString(b,c,this.encoding).replace(/\0.*$/,"")},write:function(a){var b=this.view,d=this.length===c?1:this.length-a.length;b.writeString(a,c,this.encoding),d>0&&(b.writeUint8(0),b.skip(d-1))}});i.loadData=h(function(b,c){var e;if(d(b,a.Blob)){var f=new FileReader;f.onload=f.onerror=function(){c(this.error,this.result)},f.readAsArrayBuffer(b)}else{if("string"!=typeof b)c(new TypeError("Unsupported source type."));else if(e=b.match(/^data:(.+?)(;base64)?,(.*)$/))try{var g=e[2],h=e[3];c(null,(g?atob:decodeURIComponent)(h))}catch(i){c(i)}else if("XMLHttpRequest"in a){var j=new XMLHttpRequest;j.open("GET",b,!0),"responseType"in j?j.responseType="arraybuffer":"overrideMimeType"in j?j.overrideMimeType("text/plain; charset=x-user-defined"):j.setRequestHeader("Accept-Charset","x-user-defined"),"onload"in j||(j.onreadystatechange=function(){4===this.readyState&&this.onload()});var k=function(a){c(new Error(a))};j.onload=function(){return 0!==this.status&&200!==this.status?k("HTTP Error #"+this.status+": "+this.statusText):("response"in this||(this.response=new VBArray(this.responseBody).toArray()),void c(null,this.response))},j.onerror=function(){k("Network error.")},j.send(null)}else c(new TypeError("Unsupported source type."))}}),i.load=h(function(a,b,c){i.loadData(a,function(a,d){a?c(a):c(null,new i(d,b))})}),p._toURI="URL"in a&&"createObjectURL"in URL?function(a){var b=this.seek(0,function(){return this.view.getBytes()});return URL.createObjectURL(new Blob([b],{type:a}))}:function(a){var b=this.seek(0,function(){return this.view.getString(c,c,"binary")});return"data:"+a+";base64,"+btoa(b)},p._mimeType=function(a){return a||this.typeSet["jBinary.mimeType"]||"application/octet-stream"},p.toURI=function(a){return this._toURI(this._mimeType(a))};if(l){var v=i.downloader=l.createElement("a");v.style.display="none"}return p.saveAs=h(function(a,b,c){if("string"==typeof a){"msSaveBlob"in navigator?navigator.msSaveBlob(new Blob([this.read("blob",0)],{type:this._mimeType(b)}),a):l?(v.parentNode||l.body.appendChild(v),v.href=this.toURI(b),v.download=a,v.click(),v.href=v.download=""):c(new TypeError("Saving from Web Worker is not supported.")),c()}else c(new TypeError("Unsupported storage type."))}),i});
//# sourceMappingURL=jbinary.js.map